<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>大陳文化 WebAR 導覽</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    /* 蓋在 AR 鏡頭上的 UI 層 */
    #ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); color: white; z-index: 999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      font-family: sans-serif;
    }
    #subtitle { position: absolute; bottom: 10%; background: rgba(0,0,0,0.6); padding: 10px; font-size: 18px; display: none; }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">

  <div id="ui-layer">
    <h2 id="status-text">正在取得您的 GPS 位置...</h2>
    <p id="distance-text"></p>
  </div>

  <div id="subtitle"></div>

  <a-scene 
    id="ar-scene"
    embedded 
    arjs="sourceType: webcam; debugUIEnabled: false;"
    style="display: none;">
    
    <a-marker preset="hiro" id="dachen-marker">
      <a-box position="0 0.5 0" material="color: red;" animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"></a-box>
    </a-marker>
    
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // 你的 GAS API 網址
    const gasAPI = "https://script.google.com/macros/s/AKfycbxhS77x8-ZTZXKYigLDGCZDKlQAv6vy7pPw2CZ8Kiby0Wp1UYLeJ_faTOfL1tY1vCNwPA/exec"; 
    
    // 假設我們從 GAS 抓回來的目標座標 (OpenLab 測試點)
    let targetLat = 23.476; // 替換為你的測試緯度
    let targetLng = 120.441; // 替換為你的測試經度
    let targetAudio = "";
    let targetSubtitle = "";

    const uiLayer = document.getElementById('ui-layer');
    const statusText = document.getElementById('status-text');
    const arScene = document.getElementById('ar-scene');
    const marker = document.getElementById('dachen-marker');
    const subtitleUI = document.getElementById('subtitle');
    let audioPlayer = new Audio();

    // 1. 初始化：先去 GAS 抓資料 (這裡簡化，直接啟動 GPS)
    // 實際開發可以在這裡 fetch(gasAPI) 取得資料後再啟動 GPS
    
    // 2. 啟動 GPS 監聽
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(success, error, { enableHighAccuracy: true });
    } else {
      statusText.innerText = "您的瀏覽器不支援 GPS";
    }

    function success(position) {
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      
      // 計算距離 (單位：公尺)
      const dist = calculateDistance(userLat, userLng, targetLat, targetLng);
      document.getElementById('distance-text').innerText = `距離目標還有 ${Math.round(dist)} 公尺`;

     // 【修改這裡】：不要管距離多少了，直接解鎖 AR 相機！
      uiLayer.style.display = "none"; // 隱藏等待畫面
      arScene.style.display = "block"; // 開啟 AR 相機
      
      // 假設距離小於 20 公尺，解鎖 AR 掃描
    //  if (dist <= 20) {
    //    uiLayer.style.display = "none"; // 隱藏等待畫面
    //    arScene.style.display = "block"; // 開啟 AR 相機
        // 此時系統會要求使用者允許相機權限
      }
    }

    function error() {
      statusText.innerText = "無法取得位置，請確認是否開啟手機定位權限。";
    }

    // 3. 監聽 AR 標籤掃描狀態
    marker.addEventListener('markerFound', () => {
      // 掃描到皮箱圖！播放聲音與顯示字幕
      console.log("找到標籤！");
      subtitleUI.innerText = "歡迎來到大陳新村！(大陳語音播放中...)";
      subtitleUI.style.display = "block";
      // audioPlayer.src = targetAudio; // 填入從 GAS 拿到的音檔路徑
      // audioPlayer.play();
    });

    marker.addEventListener('markerLost', () => {
      // 離開標籤範圍，停止播放
      subtitleUI.style.display = "none";
      // audioPlayer.pause();
    });

    // 輔助函數：計算兩點經緯度距離 (Haversine 公式)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // 地球半徑 (公尺)
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>
</body>

</html>
