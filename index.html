<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <!-- =========================================================
  【A. 基本設定】
  ========================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>大陳文化 WebAR 導覽</title>

  <!-- =========================================================
  【B. A-Frame / AR.js 載入】
  - A-Frame：3D 場景引擎
  - AR.js：Marker AR（Hiro 等黑白標籤）
  ========================================================== -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- =========================================================
  【C. UI 樣式】
  - UI Layer：用來顯示定位狀態、按鈕（蓋在 AR 之上）
  - Subtitle：掃到 marker 後顯示字幕
  - Debug：測試用（正式可拿掉）
  ========================================================== -->
  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }

    /* 蓋在 AR 上層的 UI */
    #ui-layer{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.82);
      color: #fff;
      z-index: 999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 18px;
      gap: 10px;
    }

    #distance-text { opacity: 0.9; }

    /* 字幕（掃到 marker 後顯示） */
    #subtitle {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10%;
      max-width: 92%;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 18px;
      display: none;
      z-index: 998;
      line-height: 1.4;
    }

    /* Debug 面板（測試用） */
    #debug {
      position: fixed;
      left: 10px;
      top: 10px;
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      max-width: 92%;
      white-space: pre-wrap;
    }

    button{
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- =========================================================
  【D. Debug 區（可選）】
  ========================================================== -->
  <div id="debug">debug...</div>

  <!-- =========================================================
  【E. UI Layer：定位/解鎖/開始掃描】
  - 初始顯示：正在取得定位
  - 達到條件後顯示：開始掃描按鈕
  ========================================================== -->
  <div id="ui-layer">
    <h2 id="status-text">正在初始化…</h2>
    <p id="distance-text"></p>
    <button id="start-btn" style="display:none;">開始掃描 Hiro</button>
    <p style="opacity:.8; font-size:14px; margin-top:8px;">
      若無法開相機/定位，請確認：<br/>
      1) 網址是 HTTPS<br/>
      2) 已允許「相機」與「定位」權限<br/>
      3) 盡量用 Safari / Chrome，不用 LINE 內建
    </p>
  </div>

  <!-- =========================================================
  【F. 字幕 UI】
  ========================================================== -->
  <div id="subtitle"></div>

  <!-- =========================================================
  【G. A-Frame AR Scene】
  ★重點：不要用 display:none 隱藏 scene（手機上易導致追蹤失效）
  - facingMode: environment → 強制後鏡頭（更亮、更適合掃標）
  - debugUIEnabled: false → 關閉 AR.js debug UI
  ========================================================== -->
  <a-scene
    id="ar-scene"
    embedded
    renderer="logarithmicDepthBuffer: true;"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false; trackingMethod: best;">

    <!-- Hiro marker -->
    <a-marker preset="hiro" id="dachen-marker">
      <!-- 看到 marker 時，你會看到這個紅色方塊 -->
      <a-box position="0 0.5 0"
             material="color: red;"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 2000">
      </a-box>
    </a-marker>

    <!-- 相機 -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- =========================================================
  【H. 主程式區（JS）】
  - H1：參數與狀態
  - H2：初始化（HTTPS 檢查、定位啟動、事件綁定）
  - H3：GPS 邏輯（距離計算、解鎖按鈕）
  - H4：AR Marker 事件（found/lost）
  - H5：音訊解鎖與播放（手機自動播放限制）
  - H6：輔助：距離計算
  ========================================================== -->
  <script>
    /* =========================================================
    【H1. 參數設定】
    ========================================================== */

    // 你的 GAS API（保留原本網址）
    const gasAPI = "https://script.google.com/macros/s/AKfycbxhS77x8-ZTZXKYigLDGCZDKlQAv6vy7pPw2CZ8Kiby0Wp1UYLeJ_faTOfL1tY1vCNwPA/exec";

    // 目標座標（之後可改成 fetch(gasAPI) 拿回來）
    let targetLat = 23.476;
    let targetLng = 120.441;

    // 解鎖距離門檻（公尺）
    // 如果你想「不管距離直接解鎖」，把它設成 Infinity，或在 onGeoSuccess 直接 unlocked = true
    const UNLOCK_DISTANCE_M = 20;

    // 音檔（先用測試 mp3，之後可改成從 GAS 回傳）
    const AUDIO_URL = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";

    /* =========================================================
    【H2. 取得 DOM 與狀態變數】
    ========================================================== */
    const uiLayer = document.getElementById("ui-layer");
    const statusText = document.getElementById("status-text");
    const distanceText = document.getElementById("distance-text");
    const startBtn = document.getElementById("start-btn");
    const subtitleUI = document.getElementById("subtitle");
    const debugUI = document.getElementById("debug");
    const marker = document.getElementById("dachen-marker");

    // GPS 解鎖狀態
    let unlocked = false;

    // 音訊播放器（同一個全域 player）
    const audioPlayer = new Audio();
    audioPlayer.src = AUDIO_URL;
    audioPlayer.loop = true;
    audioPlayer.preload = "auto";

    // iOS/Android 常需要「使用者互動」才允許播放
    let audioUnlocked = false;

    // 避免 markerFound 重複觸發造成多次 play()
    let isPlaying = false;

    /* =========================================================
    【H3. 小工具：Debug / HTTPS 檢查】
    ========================================================== */
    function setDebug(msg){
      debugUI.textContent = msg;
      console.log(msg);
    }

    function isSecureContextOK(){
      // iOS Safari/Chrome 基本上需要 https 才能用相機/定位
      return window.isSecureContext || location.hostname === "localhost";
    }

    /* =========================================================
    【H4. 初始化入口】
    ========================================================== */
    window.addEventListener("load", () => {
      // 1) HTTPS 檢查
      if (!isSecureContextOK()) {
        statusText.textContent = "❌ 網址不是 HTTPS，手機通常無法開相機/定位";
        setDebug("Not secure context. Use HTTPS.");
        return;
      }

      statusText.textContent = "正在取得定位權限…";
      setDebug("Page loaded. Waiting for geolocation...");

      // 2) 按鈕：開始掃描（同時解鎖音訊）
      startBtn.addEventListener("click", onStartScanClick);

      // 3) 啟動 GPS 監聽
      startGeolocation();

      // 4) 綁定 marker 事件
      bindMarkerEvents();

      // （可選）嘗試提亮相機（不保證每台手機有效）
      // setTimeout(tryBoostCameraExposure, 1200);
    });

    /* =========================================================
    【H5. GPS：啟動與回呼】
    ========================================================== */
    function startGeolocation(){
      if (!navigator.geolocation) {
        statusText.textContent = "❌ 瀏覽器不支援 GPS";
        setDebug("Geolocation not supported.");
        return;
      }

      navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 15000
      });
    }

    function onGeoSuccess(position){
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;

      const dist = calculateDistance(userLat, userLng, targetLat, targetLng);
      distanceText.textContent = `距離目標約 ${Math.round(dist)} 公尺`;

      setDebug(
        `GPS OK\n` +
        `user: ${userLat.toFixed(6)}, ${userLng.toFixed(6)}\n` +
        `target: ${targetLat}, ${targetLng}\n` +
        `dist: ${dist.toFixed(1)}m\n` +
        `unlocked: ${unlocked}\n` +
        `audioUnlocked: ${audioUnlocked}\n` +
        `isPlaying: ${isPlaying}`
      );

      // 解鎖條件：距離 <= 門檻
      // 若你要「不管距離直接解鎖」，改成：if (!unlocked) { unlocked = true; ... }
      if (!unlocked && dist <= UNLOCK_DISTANCE_M) {
        unlocked = true;
        statusText.textContent = "✅ 已到達範圍，請按「開始掃描 Hiro」";
        startBtn.style.display = "inline-block";
      } else if (!unlocked) {
        statusText.textContent = "請靠近目標點以解鎖掃描…";
        startBtn.style.display = "none";
      }
    }

    function onGeoError(err){
      statusText.textContent = "❌ 無法取得位置，請確認已開啟定位權限";
      setDebug("Geo error: " + (err && err.message ? err.message : "unknown"));
    }

    /* =========================================================
    【H6. 使用者點擊「開始掃描」】
    - 目的 1：把 UI layer 隱藏，讓使用者看到 AR 相機畫面
    - 目的 2：先做一次 play/pause → 解鎖手機自動播放限制
    ========================================================== */
    async function onStartScanClick(){
      // 1) 嘗試解鎖音訊（iOS/Android 很重要）
      if (!audioUnlocked) {
        try {
          await audioPlayer.play();   // 先播放一下
          audioPlayer.pause();        // 再暫停
          audioPlayer.currentTime = 0;
          audioUnlocked = true;
          console.log("Audio unlocked ✅");
        } catch (e) {
          console.log("Audio unlock failed (still ok):", e);
          // 就算解鎖失敗也不要卡住流程，後面 markerFound 會再試一次
        }
      }

      // 2) 隱藏 UI，開始掃描
      uiLayer.style.display = "none";
    }

    /* =========================================================
    【H7. Marker 事件：markerFound / markerLost】
    - markerFound：掃到 Hiro（紅方塊出現）→ 顯示字幕 + 播放語音
    - markerLost：移開 Hiro → 隱藏字幕 + 暫停語音
    ========================================================== */
    function bindMarkerEvents(){
      marker.addEventListener("markerFound", async () => {
        console.log("找到標籤！觸發導覽");
        setDebug(debugUI.textContent + "\nmarkerFound ✅");

        // 1) 顯示字幕
        subtitleUI.innerText = "歡迎來到大陳新村！(語音導覽播放中...)";
        subtitleUI.style.display = "block";

        // 2) 播放音訊（避免重複播放）
        if (!isPlaying) {
          try {
            await audioPlayer.play();
            isPlaying = true;
          } catch (error) {
            console.log("瀏覽器阻擋播放，需要先點擊螢幕", error);
            subtitleUI.innerText = "請點擊螢幕任意處以播放聲音";
          }
        }
      });

      marker.addEventListener("markerLost", () => {
        console.log("標籤遺失！停止導覽");
        setDebug(debugUI.textContent + "\nmarkerLost");

        // 1) 隱藏字幕
        subtitleUI.style.display = "none";

        // 2) 暫停音訊
        audioPlayer.pause();
        isPlaying = false;
      });

      // 保險：若 markerFound 時被擋播放，使用者「任意點擊」就再嘗試播放
      document.body.addEventListener("click", async () => {
        if (subtitleUI.style.display === "block" && !isPlaying) {
          try {
            await audioPlayer.play();
            isPlaying = true;
            subtitleUI.innerText = "歡迎來到大陳新村！(語音導覽播放中...)";
          } catch (e) {
            console.log("Still blocked:", e);
          }
        }
      }, { passive: true });
    }

    /* =========================================================
    【H8. （可選）嘗試提亮相機】
    - 有些 Android 機型有效，iOS 通常不理
    - 失敗會忽略，不會讓相機掛掉
    ========================================================== */
    async function tryBoostCameraExposure(){
      try {
        const video = document.querySelector("video");
        if (!video || !video.srcObject) return;

        const track = video.srcObject.getVideoTracks()[0];
        if (!track) return;

        const caps = track.getCapabilities ? track.getCapabilities() : null;
        console.log("Camera caps:", caps);

        const constraints = {};
        if (caps?.exposureMode) constraints.exposureMode = "continuous";
        if (caps?.whiteBalanceMode) constraints.whiteBalanceMode = "continuous";
        if (caps?.exposureCompensation) constraints.exposureCompensation = caps.exposureCompensation.max;
        if (caps?.brightness) constraints.brightness = caps.brightness.max;

        if (Object.keys(constraints).length === 0) return;
        await track.applyConstraints({ advanced: [constraints] });

        console.log("Applied camera constraints:", constraints);
      } catch (e) {
        console.warn("applyConstraints failed (ignored):", e);
      }
    }

    /* =========================================================
    【H9. 距離計算（Haversine）】
    ========================================================== */
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>

</body>
</html>
