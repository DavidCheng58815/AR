<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>大陳文化 WebAR 導覽</title>

  <!-- A-Frame / AR.js -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }

    /* UI 蓋在 AR 上層 */
    #ui-layer{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.82);
      color: #fff;
      z-index: 999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 18px;
      gap: 10px;
    }

    #distance-text { opacity: 0.9; }

    #subtitle {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10%;
      max-width: 92%;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 18px;
      display: none;
      z-index: 998;
      line-height: 1.4;
    }

    #debug {
      position: fixed;
      left: 10px;
      top: 10px;
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      max-width: 92%;
      white-space: pre-wrap;
    }

    button{
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- Debug 區（你測試用，正式可拿掉） -->
  <div id="debug">debug...</div>

  <!-- UI 遮罩：先拿 GPS，確認後才讓使用者開始掃描 -->
  <div id="ui-layer">
    <h2 id="status-text">正在初始化…</h2>
    <p id="distance-text"></p>
    <button id="start-btn" style="display:none;">開始掃描 Hiro</button>
    <p style="opacity:.8; font-size:14px; margin-top:8px;">
      若無法開相機，請確認：<br/>
      1) 網址是 HTTPS<br/>
      2) 已允許「相機」與「定位」權限
    </p>
  </div>

  <div id="subtitle"></div>

  <!-- ✅ 不要 display:none！讓 A-Frame/AR.js 在手機上穩定初始化 -->
  <a-scene
    id="ar-scene"
    embedded
    renderer="logarithmicDepthBuffer: true;"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;">

    <!-- Hiro marker -->
    <a-marker preset="hiro" id="dachen-marker">
      <a-box position="0 0.5 0"
             material="color: red;"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 2000">
      </a-box>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // ====== 可調整參數 ======
    const gasAPI = "https://script.google.com/macros/s/AKfycbxhS77x8-ZTZXKYigLDGCZDKlQAv6vy7pPw2CZ8Kiby0Wp1UYLeJ_faTOfL1tY1vCNwPA/exec";

    // 測試目標座標（之後你可以改成 fetch(gasAPI) 拿）
    let targetLat = 23.476;
    let targetLng = 120.441;

    // 距離門檻（你想要不管距離就解鎖，也可以設成 Infinity）
    const UNLOCK_DISTANCE_M = 20;

    // ====== DOM ======
    const uiLayer = document.getElementById("ui-layer");
    const statusText = document.getElementById("status-text");
    const distanceText = document.getElementById("distance-text");
    const startBtn = document.getElementById("start-btn");
    const subtitleUI = document.getElementById("subtitle");
    const debugUI = document.getElementById("debug");

    const marker = document.getElementById("dachen-marker");
    // ===== 音訊設定 =====
    const audioPlayer = new Audio();
    audioPlayer.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";
    audioPlayer.loop = true;
    audioPlayer.preload = "auto";

    let audioUnlocked = false;  // 是否已完成「使用者互動解鎖音訊」
    let isPlaying = false;      // 避免 markerFound 重複觸發一直 play
    let unlocked = false;
    let lastDist = null;

    // ====== 小工具 ======
    function setDebug(msg){
      debugUI.textContent = msg;
      console.log(msg);
    }

    function isSecureContextOK(){
      // iOS Safari/Chrome 都需要 https 才能穩定用相機
      return window.isSecureContext || location.hostname === "localhost";
    }

    // ====== 初始化 ======
    window.addEventListener("load", () => {
      if (!isSecureContextOK()) {
        statusText.textContent = "❌ 網址不是 HTTPS，手機通常無法開相機/定位";
        setDebug("Not secure context. Use HTTPS.");
        return;
      }

      statusText.textContent = "正在取得定位權限…";
      setDebug("Page loaded. Waiting for geolocation...");

      // 先讓使用者點一下（iOS 對某些權限/音訊/相機啟動更友善）
     startBtn.addEventListener("click", async () => {
  // 先解鎖音訊（iOS/Android 常需要）
  if (!audioUnlocked) {
    try {
      await audioPlayer.play();   // 先播放一下
      audioPlayer.pause();        // 再暫停
      audioPlayer.currentTime = 0;
      audioUnlocked = true;
      console.log("Audio unlocked ✅");
    } catch (e) {
      console.log("Audio unlock failed (still ok):", e);
    }
  }

  // 把 UI 蓋掉，開始掃
  uiLayer.style.display = "none";
});

      startGeolocation();
      bindMarkerEvents();
    });

    function startGeolocation(){
      if (!navigator.geolocation) {
        statusText.textContent = "❌ 瀏覽器不支援 GPS";
        setDebug("Geolocation not supported.");
        return;
      }

      navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 15000
      });
    }
    async function tryBoostCameraExposure(){
  try {
    // A-Frame 會建立 <video> 元素，AR.js 用它當相機來源
    const video = document.querySelector("video");
    if (!video || !video.srcObject) return;

    const track = video.srcObject.getVideoTracks()[0];
    if (!track) return;

    const caps = track.getCapabilities ? track.getCapabilities() : null;
    console.log("Camera caps:", caps);

    // 盡可能用「通用且不容易爆」的 constraints
    const constraints = {};

    // 這兩個在部分 Android 會有效，iOS 多半不理
    if (caps?.exposureMode) constraints.exposureMode = "continuous";
    if (caps?.whiteBalanceMode) constraints.whiteBalanceMode = "continuous";

    // 下面幾個看手機支援度（Android 部分機型有效）
    // 若 caps 沒有就不設，避免報錯
    if (caps?.brightness) constraints.brightness = caps.brightness.max;
    if (caps?.contrast) constraints.contrast = caps.contrast.max;
    if (caps?.saturation) constraints.saturation = caps.saturation.max;

    // 有些機型提供 exposureCompensation（最有用）
    if (caps?.exposureCompensation) constraints.exposureCompensation = caps.exposureCompensation.max;

    if (Object.keys(constraints).length === 0) return;

    await track.applyConstraints({ advanced: [constraints] });
    console.log("Applied camera constraints:", constraints);
  } catch (e) {
    console.warn("applyConstraints failed (ignored):", e);
  }
}
    function onGeoSuccess(position){
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;

      const dist = calculateDistance(userLat, userLng, targetLat, targetLng);
      lastDist = dist;
      distanceText.textContent = `距離目標約 ${Math.round(dist)} 公尺`;

      setDebug(
        `GPS OK\n` +
        `user: ${userLat.toFixed(6)}, ${userLng.toFixed(6)}\n` +
        `target: ${targetLat}, ${targetLng}\n` +
        `dist: ${dist.toFixed(1)}m\n` +
        `unlocked: ${unlocked}`
      );

      // 解鎖條件：距離 <= 門檻
      // 如果你要「不管距離直接解鎖」，就把 if 改成：if (!unlocked) { ... }
      if (!unlocked && dist <= UNLOCK_DISTANCE_M) {
        unlocked = true;
        statusText.textContent = "✅ 已到達範圍，請按「開始掃描 Hiro」";
        startBtn.style.display = "inline-block";
      } else if (!unlocked) {
        statusText.textContent = "請靠近目標點以解鎖掃描…";
        startBtn.style.display = "none";
      }
    }

    function onGeoError(err){
      statusText.textContent = "❌ 無法取得位置，請確認已開啟定位權限";
      setDebug("Geo error: " + (err && err.message ? err.message : "unknown"));
    }

    function bindMarkerEvents(){
      // 注意：這段只有在 JS 沒語法錯誤 + AR 正常初始化時才會觸發
     marker.addEventListener("markerFound", async () => {
  console.log("找到標籤！觸發導覽");

  // 1) 顯示字幕
  subtitleUI.innerText = "歡迎來到大陳新村！(大陳語音導覽播放中...)";
  subtitleUI.style.display = "block";

  // 2) 播放音訊（避免重複播放）
  if (!isPlaying) {
    try {
      await audioPlayer.play();
      isPlaying = true;
    } catch (error) {
      console.log("瀏覽器阻擋播放，需要先點擊螢幕", error);
      subtitleUI.innerText = "請點擊螢幕任意處以播放聲音";
    }
  }
});

marker.addEventListener("markerLost", () => {
  console.log("標籤遺失！停止導覽");

  // 1) 隱藏字幕
  subtitleUI.style.display = "none";

  // 2) 停止音訊
  audioPlayer.pause();
  isPlaying = false;
});

    // Haversine
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2-lat1) * Math.PI/180;
      const Δλ = (lon2-lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
  </script>

</body>
</html>


